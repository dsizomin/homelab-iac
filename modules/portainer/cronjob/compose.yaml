services:
  hypervisor:
    image: crazymax/swarm-cronjob
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    environment:
      TZ: "Europe/Amsterdam"
      LOG_LEVEL: "info"
      LOG_JSON: "false"
    deploy:
      placement:
        constraints:
          - node.role == manager
    networks:
      - service_network

  healthchecks:
    image: healthchecks/healthchecks:latest
    environment:
      - DB=sqlite
      - DB_NAME=/data/hc.sqlite
      - DEBUG=False
      - SECRET_KEY_FILE=/run/secrets/secret_key
      - SITE_ROOT=https://${HEALTHCHECKS_HOST}
      - ALLOWED_HOSTS=tasks.cronjob_healthchecks,${HEALTHCHECKS_HOST}
      - REMOTE_USER_HEADER=HTTP_X_AUTHENTIK_EMAIL
      - APPRISE_ENABLED=True
    volumes:
      - healthchecks-data:/data
    networks:
      - proxy_network
      - service_network
    secrets:
      - secret_key
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.middlewares.healthchecks.forwardauth.address=http://tasks.authentik_webserver:9000/outpost.goauthentik.io/auth/traefik"
        - "traefik.http.middlewares.healthchecks.forwardauth.trustForwardHeader=true"
        - "traefik.http.middlewares.healthchecks.forwardauth.authResponseHeaders=X-authentik-username,X-authentik-groups,X-authentik-entitlements,X-authentik-email,X-authentik-name,X-authentik-uid,X-authentik-jwt,X-authentik-meta-jwks,X-authentik-meta-outpost,X-authentik-meta-provider,X-authentik-meta-app,X-authentik-meta-version"
        - "traefik.http.routers.healthchecks.rule=Host(`${HEALTHCHECKS_HOST}`)"
        - "traefik.http.routers.healthchecks.middlewares=healthchecks"
        - "traefik.http.routers.healthchecks-auth.rule=Host(`${HEALTHCHECKS_HOST}`) && PathPrefix(`/outpost.goauthentik.io/`)"
        - "traefik.http.routers.healthchecks-auth.service=authentik"
        - "traefik.http.services.healthchecks.loadbalancer.server.port=8000"

secrets:
  secret_key:
    name: ${SECRET_KEY}
    external: true

volumes:
  healthchecks-data:

networks:
  proxy_network:
    name: ${PROXY_NETWORK}
    external: true
  service_network:
    name: ${SERVICE_NETWORK}
    external: true
