// Export Alloy metrics in memory.
prometheus.exporter.self "integrations_alloy_health" { }

// Target Alloy metrics with the following additional labels:
//   * job: "integrations/alloy" is compatible with Grafana Cloud's Alloy Health Integrations.
//   * collector_id: The unique collector ID matching the remotecfg id argument value.
//                   Used to match collector-specific metrics to power the 'Collector
//                   Health' section of the Fleet Management UI.
//   * instance: The hostname of the machine running Alloy.
discovery.relabel "integrations_alloy_health" {
  targets = prometheus.exporter.self.integrations_alloy_health.targets

  rule {
    action       = "replace"
    target_label = "collector_id"
    replacement  = argument.attributes.value["collector.ID"]
  }

  rule {
    target_label = "instance"
    replacement  = constants.hostname
  }

  rule {
    target_label = "job"
    replacement  = "integrations/alloy"
  }
}

// Scrape Alloy metrics and forward them to the remote write component.
prometheus.scrape "integrations_alloy_health" {
  targets = array.concat(
    discovery.relabel.integrations_alloy_health.output,
  )
  forward_to = [prometheus.relabel.integrations_alloy_health.receiver]
  job_name   = "integrations/alloy"
}

// Select only the metrics that are relevant to the Alloy Health Integrations.
prometheus.relabel "integrations_alloy_health" {
  forward_to = [prometheus.remote_write.default.receiver]

  rule {
    source_labels = ["__name__"]
    regex         = "alloy_build_info|alloy_component_controller_running_components|alloy_component_dependencies_wait_seconds|alloy_component_dependencies_wait_seconds_bucket|alloy_component_evaluation_seconds|alloy_component_evaluation_seconds_bucket|alloy_component_evaluation_seconds_count|alloy_component_evaluation_seconds_sum|alloy_component_evaluation_slow_seconds|alloy_config_hash|alloy_resources_machine_rx_bytes_total|alloy_resources_machine_tx_bytes_total|alloy_resources_process_cpu_seconds_total|alloy_resources_process_resident_memory_bytes|cluster_node_gossip_health_score|cluster_node_gossip_proto_version|cluster_node_gossip_received_events_total|cluster_node_info|cluster_node_lamport_time|cluster_node_peers|cluster_node_update_observers|cluster_transport_rx_bytes_total|cluster_transport_rx_packet_queue_length|cluster_transport_rx_packets_failed_total|cluster_transport_rx_packets_total|cluster_transport_stream_rx_bytes_total|cluster_transport_stream_rx_packets_failed_total|cluster_transport_stream_rx_packets_total|cluster_transport_stream_tx_bytes_total|cluster_transport_stream_tx_packets_failed_total|cluster_transport_stream_tx_packets_total|cluster_transport_streams|cluster_transport_tx_bytes_total|cluster_transport_tx_packet_queue_length|cluster_transport_tx_packets_failed_total|cluster_transport_tx_packets_total|go_gc_duration_seconds_count|go_goroutines|go_memstats_heap_inuse_bytes|otelcol_exporter_send_failed_spans_total|otelcol_exporter_sent_spans_total|otelcol_processor_batch_batch_send_size_bucket|otelcol_processor_batch_metadata_cardinality|otelcol_processor_batch_timeout_trigger_send_total|otelcol_receiver_accepted_spans_total|otelcol_receiver_refused_spans_total|prometheus_remote_storage_bytes_total|prometheus_remote_storage_highest_timestamp_in_seconds|prometheus_remote_storage_metadata_bytes_total|prometheus_remote_storage_queue_highest_sent_timestamp_seconds|prometheus_remote_storage_samples_failed_total|prometheus_remote_storage_samples_retried_total|prometheus_remote_storage_samples_total|prometheus_remote_storage_sent_batch_duration_seconds_bucket|prometheus_remote_storage_sent_batch_duration_seconds_count|prometheus_remote_storage_sent_batch_duration_seconds_sum|prometheus_remote_storage_shards|prometheus_remote_storage_shards_max|prometheus_remote_storage_shards_min|prometheus_remote_write_wal_samples_appended_total|prometheus_remote_write_wal_storage_active_series|rpc_server_duration_milliseconds_bucket|scrape_duration_seconds|loki_write_sent_bytes_total|loki_write_sent_entries_total|pyroscope_write_sent_bytes_total|pyroscope_write_sent_profiles_total|prometheus_remote_storage_histograms_total|prometheus_remote_storage_exemplars_total|alloy_queue_metadata_network_sent_total|otelcol_exporter_sent_log_records|otelcol_exporter_sent_metric_points|otelcol_exporter_sent_spans|up"
    action        = "keep"
  }
}

// Write metrics to your Grafana Cloud Prometheus instance.
prometheus.remote_write "default" {
  endpoint {
    url = "https://prometheus-prod-65-prod-eu-west-2.grafana.net/api/prom/push"

    basic_auth {
      username      = "2856345"
      password_file = "/run/secrets/grafana_api_key"
    }
  }
}

discovery.docker "logs_integrations_docker" {
	host             = "unix:///var/run/docker.sock"
	refresh_interval = "5s"

	filter {
		name   = "id"
		values = [constants.hostname]
	}
}

loki.source.docker "logs_integrations_docker" {
	host             = "unix:///var/run/docker.sock"
	targets          = discovery.docker.logs_integrations_docker.targets
	forward_to       = [loki.write.grafana_cloud_loki.receiver]
	refresh_interval = "5s"

	labels = {
		"collector_id" = argument.attributes.value["collector.ID"],
		"instance"     = constants.hostname,
		"job"          = "integrations/docker",
	}
}

loki.write "grafana_cloud_loki" {
	endpoint {
		url = "https://logs-prod-012.grafana.net/loki/api/v1/push"

		basic_auth {
			username      = "1423849"
			password_file = "/run/secrets/grafana_api_key"
		}
	}
}
